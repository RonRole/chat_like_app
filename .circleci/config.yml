version: 2
jobs:
  build:
    machine: true
    steps:
      - checkout
      - run:
          name: Up Docker Image
          command: docker-compose up -d
      # - run:
      #     name: コンテナに入ってみる
      #     command: docker exec -it project_front_1 sh
      # - run:
      #     name: Run tests
      #     command:
      - run:
          name: setup db
          command: |
            docker-compose run --rm back rails db:create
            docker-compose run --rm back rails db:migrate RAILS_ENV=development
      - run:
          name: docker-compose down 
          command: |
            docker-compose down 
      # herokuに乗っける
      # - run:
      #     name: deploy on heroku
      #     command: |
  deploy:
      machine: true
      steps:
        - checkout
        - run:
            name: deploy on heroku
            command: |
              heroku buildpacks:set heroku/nodejs
              heroku buildpacks:add --index 1 heroku/rails
              git push https://heroku:$HEROKU_API_KEY@git.heroku.com/$HEROKU_APP_NAME.git master
workflows:
  version: 2
  build-deploy:
    jobs:
      - build
      - deploy:
          requires:
            - build
          filters:
            branches:
              only: master
  
